name: Build

on:
  push:
    branches:
      - trunk
      - ci/**
  pull_request:

env:
  RUSTFLAGS: -D warnings
  RUSTDOCFLAGS: -D warnings
  CI_RUST_VERSION: "1.85"
  MSRV: "1.56"

jobs:
  build:
    timeout-minutes: 10

    strategy:
      matrix:
        include:
          # wasm stable
          - name: "stable wasm"
            os: "ubuntu-latest"
            target: "wasm32-unknown-unknown"

          # native stable
          - name: "stable linux"
            os: "ubuntu-latest"
            target: "x86_64-unknown-linux-gnu"

          - name: "stable mac"
            os: "macos-latest"
            target: "x86_64-apple-darwin"

          - name: "stable windows"
            os: "windows-latest"
            target: "x86_64-pc-windows-msvc"

      fail-fast: false

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }}

    steps:
      - name: checkout repo
        uses: actions/checkout@v2

      - name: install rust
        shell: bash
        run: |
          set -e

          rustup toolchain install ${{ env.CI_RUST_VERSION }} --no-self-update --profile=minimal --component clippy
          rustup override set ${{ env.CI_RUST_VERSION }}
          rustup target add ${{ matrix.target }}
          cargo -V

      - name: clippy
        shell: bash
        run: |
          set -e

          cargo clippy --target ${{ matrix.target }}
          cargo clippy --target ${{ matrix.target }} --no-default-features

      - name: test
        shell: bash
        if: matrix.name != 'stable wasm'
        run: |
          set -e

          cargo test --target ${{ matrix.target }}

      - name: doc
        shell: bash
        run: |
          set -e

          cargo doc --no-deps --target ${{ matrix.target }}

  msrv:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v2

      - name: install rust
        run: |
          set -e

          rustup toolchain install ${{ env.MSRV }} --no-self-update --profile=minimal
          rustup override set ${{ env.MSRV }}
          cargo -V

      - name: check msrv
        run: |
          set -e

          cargo check
          cargo check --no-default-features

  cargo-fmt:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v2

      - name: install rust
        run: |
          set -e

          rustup toolchain install ${{ env.CI_RUST_VERSION }} --no-self-update --profile=minimal --component rustfmt
          rustup override set ${{ env.CI_RUST_VERSION }}
          cargo -V

      - name: check format
        run: |
          set -e

          cargo fmt -- --check

  cargo-deny:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v2

      - name: check denies
        uses: EmbarkStudios/cargo-deny-action@v1
        with:
          log-level: warn
          command: check
          arguments: --all-features
